<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Doggyco 3.2 - Final Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { 
            --retro-yellow: #ffd166; --retro-pink: #ff9ecf; 
            --retro-blue: #4facfe; --retro-green: #06d6a0; --retro-red: #ef476f; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        
        body {
            font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: white;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 5px;
            overflow: hidden;
        }

        .retro-title { font-family: 'Press Start 2P'; font-size: 1.2rem; color: var(--retro-yellow); margin: 10px 0; text-shadow: 2px 2px #000; }

        /* Fortschrittsbalken */
        #progressContainer {
            width: 100%; max-width: 400px; background: #333; height: 35px; 
            border-radius: 10px; border: 3px solid white; position: relative; overflow: hidden; margin-bottom: 10px;
        }
        #progressBar { width: 0%; height: 100%; background: var(--retro-red); transition: width 0.3s ease; }
        #progressText { position: absolute; width: 100%; text-align: center; top: 8px; font-family: 'Press Start 2P'; font-size: 0.6rem; color: white; pointer-events: none; }

        #gameWrapper {
            position: relative; width: 400px; height: 700px; background: #87CEEB; 
            border-radius: 20px; border: 4px solid white; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        #uiPanel {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(255,255,255,0.9); color: #333; padding: 8px;
            border-radius: 8px; display: flex; justify-content: space-between; font-weight: bold; z-index: 10;
        }

        #controlBar { position: absolute; bottom: 0; width: 100%; height: 70px; background: #111; display: flex; justify-content: center; align-items: center; }
        #slider { width: 85%; height: 35px; accent-color: var(--retro-pink); cursor: pointer; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center;
        }

        button {
            padding: 15px 30px; font-family: 'Press Start 2P'; font-size: 0.8rem;
            background: var(--retro-green); border: none; border-radius: 10px; cursor: pointer; color: white;
        }

        #heartContainer { color: var(--retro-red); font-size: 1.2rem; }

        @media (max-width: 450px) {
            #gameWrapper { width: 95vw; height: 75vh; }
            #progressContainer { width: 95vw; }
        }
    </style>
</head>
<body>

    <h1 class="retro-title">DOGGYCO 3.2</h1>

    <div id="progressContainer">
        <div id="progressBar"></div>
        <div id="progressText">QUOTE: 0% (ZIEL: 80%)</div>
    </div>

    <div id="gameWrapper">
        <div id="uiPanel">
            <div>‚≠ê <span id="score">0</span></div>
            <div id="heartContainer">‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è</div>
            <div>‚è± <span id="time">30</span></div>
        </div>
        <canvas id="game"></canvas>
        <div id="controlBar"><input type="range" id="slider" min="30" max="370"></div>

        <div class="overlay" id="startScreen">
            <p style="margin-bottom: 20px; font-size: 0.7rem; line-height: 1.6;">ERREICHE 80% IN 30 SEKUNDEN!<br>VORSICHT VOR SPINNEN (-20%)</p>
            <button onclick="startGame()">START GAME</button>
        </div>
        
        <div class="overlay" id="gameOver" style="display:none;">
            <h2 style="font-family:'Press Start 2P'; color:var(--retro-red); margin-bottom: 20px;">GAME OVER</h2>
            <p id="finalScore" style="margin-bottom: 20px;"></p>
            <button onclick="location.reload()">RETRY</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const slider = document.getElementById("slider");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    let state = "start", score = 0, lives = 3, timeLeft = 30, items = [], dog = {x:200, hit: 0}, itemsSpawned = 0, itemsCaught = 0, audioCtx;
    let clouds = [{x: 50, y: 60, s: 0.3}, {x: 300, y: 150, s: 0.5}];
    let spiders = [{x: 100, t: 0}, {x: 300, t: Math.PI}];

    function resize() {
        canvas.width = document.getElementById("gameWrapper").clientWidth;
        canvas.height = document.getElementById("gameWrapper").clientHeight - 70;
    }
    window.addEventListener("resize", resize); resize();

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playSfx(f, t, d) {
        if (!audioCtx) return;
        let o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = t; o.frequency.value = f; g.gain.value = 0.1;
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.stop(audioCtx.currentTime + d);
    }

    function startGame() {
        initAudio(); score = 0; lives = 3; itemsSpawned = 0; itemsCaught = 0; timeLeft = 30; items = [];
        state = "play"; document.getElementById("startScreen").style.display = "none"; loop();
    }

    function loop() {
        if (state !== "play") return;
        ctx.clearRect(0,0,canvas.width, canvas.height);

        // 1. Himmel & Wolken
        ctx.fillStyle = "#87CEEB"; ctx.fillRect(0,0,canvas.width, canvas.height);
        clouds.forEach(c => {
            c.x += c.s; if(c.x > canvas.width + 50) c.x = -60;
            ctx.font = "50px Arial"; ctx.fillText("‚òÅÔ∏è", c.x, c.y);
        });

        // 2. Stra√üe & Gras
        ctx.fillStyle = "#6cc24a"; ctx.fillRect(0, canvas.height-60, canvas.width, 60);
        ctx.fillStyle = "#444"; ctx.fillRect(0, canvas.height-40, canvas.width, 40);
        ctx.strokeStyle = "white"; ctx.setLineDash([15, 15]); ctx.beginPath(); ctx.moveTo(0, canvas.height-20); ctx.lineTo(canvas.width, canvas.height-20); ctx.stroke(); ctx.setLineDash([]);

        // 3. Spinnen Logic
        spiders.forEach(s => {
            s.t += 0.02;
            let spiderY = 150 + Math.sin(s.t) * 120;
            ctx.strokeStyle = "white"; ctx.beginPath(); ctx.moveTo(s.x, 0); ctx.lineTo(s.x, spiderY); ctx.stroke();
            ctx.font = "35px Arial"; ctx.fillText("üï∑Ô∏è", s.x - 17, spiderY + 10);
            
            // Kollision Spinne (-20%)
            if (Math.abs(s.x - dog.x) < 35 && Math.abs(spiderY - (canvas.height-85)) < 40) {
                let penalty = Math.ceil(itemsSpawned * 0.2);
                itemsCaught = Math.max(0, itemsCaught - penalty);
                dog.hit = 15; playSfx(120, 'sawtooth', 0.3);
                s.t += Math.PI; // Spinne "h√ºpft" weg
            }
        });

        // 4. Items Spawning
        if (Math.random() < 0.04) {
            let r = Math.random();
            let type = "ü¶¥", val = 1, danger = false;
            if (r < 0.1) { type = "üëÆ"; danger = true; }
            else if (r < 0.3) { type = "üçó"; val = 3; }
            else if (r < 0.6) { type = "üç™"; val = 2; }
            items.push({ x: 40 + Math.random()*(canvas.width-80), y: -50, type, val, danger, speed: 3.5 });
            if (!danger) itemsSpawned++;
        }

        // 5. Items Logic
        items.forEach((it, i) => {
            it.y += it.speed;
            if(it.type === "üëÆ") {
                ctx.fillStyle = (Math.floor(Date.now()/150)%2) ? "rgba(255,0,0,0.3)" : "transparent";
                ctx.beginPath(); ctx.arc(it.x, it.y-15, 25, 0, Math.PI*2); ctx.fill();
            }
            ctx.font = "40px Arial"; ctx.fillText(it.type, it.x - 20, it.y);

            if (it.y > canvas.height - 110 && it.y < canvas.height - 40 && Math.abs(it.x - dog.x) < 35) {
                if (it.danger) { lives--; dog.hit = 25; playSfx(100, 'square', 0.4); updateHeartUI(); }
                else { itemsCaught++; score += it.val; playSfx(700, 'sine', 0.1); }
                items.splice(i, 1);
            } else if (it.y > canvas.height) { items.splice(i, 1); }
        });

        // 6. Hund Animation & Zeichnen
        dog.x = parseInt(slider.value);
        let bounce = Math.sin(Date.now()/150) * 4;
        ctx.save();
        if(dog.hit > 0) { ctx.filter = "sepia(1) saturate(10) hue-rotate(-50deg)"; dog.hit--; }
        ctx.font = "60px Arial"; 
        ctx.fillText("üê∂", dog.x - 30, canvas.height - 80 + bounce);
        ctx.restore();

        // 7. Progress & UI
        let pct = itemsSpawned > 0 ? Math.round((itemsCaught / itemsSpawned) * 100) : 0;
        progressBar.style.width = Math.min(pct, 100) + "%";
        progressBar.style.background = pct < 80 ? "var(--retro-red)" : "var(--retro-green)";
        progressText.innerText = `QUOTE: ${pct}% (ZIEL: 80%)`;

        timeLeft -= 1/60;
        document.getElementById("score").innerText = score;
        document.getElementById("time").innerText = Math.max(0, Math.ceil(timeLeft));

        if (lives <= 0) return endGame();
        if (timeLeft <= 0) {
            if (pct >= 80) { 
                playSfx(900, 'sine', 0.6); alert("LEVEL GESCHAFFT!"); 
                timeLeft = 30; itemsSpawned = 0; itemsCaught = 0; 
            } else { 
                lives--; updateHeartUI(); 
                if(lives > 0) { alert("QUOTE ZU NIEDRIG! -1 HERZ"); timeLeft = 30; itemsSpawned = 0; itemsCaught = 0; }
                else endGame();
            }
        }
        requestAnimationFrame(loop);
    }

    function updateHeartUI() {
        let h = "";
        for(let i=0; i<3; i++) h += i < lives ? "‚ù§Ô∏è " : "üñ§ ";
        document.getElementById("heartContainer").innerHTML = h;
    }

    function endGame() {
        state = "over";
        document.getElementById("finalScore").innerText = "SCORE: " + score;
        document.getElementById("gameOver").style.display = "flex";
    }

</script>
</body>
</html>

