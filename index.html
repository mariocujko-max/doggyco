<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Doggyco 3.2 - Global Retro</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        :root {
            --retro-yellow: #ffd166;
            --retro-pink: #ff9ecf;
            --retro-blue: #4facfe;
            --retro-green: #06d6a0;
            --retro-red: #ef476f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }

        .retro-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            color: var(--retro-yellow);
            text-shadow: 3px 3px 0px var(--retro-red);
            margin: 20px 0;
            text-align: center;
        }

        #mainContainer {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1100px;
        }

        /* RANGLISTE */
        #leaderboard {
            flex: 1;
            min-width: 250px;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--retro-blue);
            height: fit-content;
        }

        #leaderboard h3 { 
            font-family: 'Press Start 2P'; 
            font-size: 0.7rem; 
            margin-bottom: 15px; 
            color: var(--retro-pink); 
            text-align: center; 
        }

        .score-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-family: 'Courier New', Courier, monospace; 
            border-bottom: 1px solid #333;
            padding-bottom: 3px;
        }

        /* GAME WRAPPER */
        #gameWrapper {
            position: relative;
            width: 400px;
            height: 600px;
            border-radius: 20px;
            background: #87CEEB;
            overflow: hidden;
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #uiPanel {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 10px;
            color: #333; font-weight: bold; z-index: 10;
        }

        #levelIndicator {
            position: absolute;
            top: 60px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.7rem;
            text-align: center;
            z-index: 5;
            width: 80%;
        }

        .goal-bar-bg { width: 100%; height: 8px; background: #444; border-radius: 4px; margin-top: 5px; overflow: hidden;}
        #goalBarFill { width: 0%; height: 100%; background: var(--retro-green); transition: width 0.3s; }

        #controlBar {
            position: absolute;
            bottom: 0; width: 100%; height: 65px;
            background: #111; display: flex; justify-content: center; align-items: center;
        }

        #slider { width: 85%; height: 15px; accent-color: var(--retro-blue); cursor: pointer; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; text-align: center;
            padding: 25px;
        }

        button {
            padding: 15px 30px; border: none; border-radius: 50px;
            background: linear-gradient(45deg, var(--retro-pink), var(--retro-yellow));
            font-family: 'Press Start 2P', cursive; font-size: 0.7rem; cursor: pointer; 
            margin-top: 20px; box-shadow: 0 4px 0 #b38b2d;
        }
        button:active { transform: translateY(4px); box-shadow: none; }

        input {
            padding: 12px; border-radius: 5px; border: none; text-align: center;
            font-family: 'Press Start 2P', cursive; font-size: 0.6rem; width: 80%;
        }

        @media (max-width: 600px) {
            #gameWrapper { width: 100%; height: 500px; }
            #leaderboard { width: 100%; order: 2; margin-top: 20px; }
        }
    </style>
</head>
<body>

    <h1 class="retro-title">DOGGYCO 3.2</h1>

    <div id="mainContainer">
        <div id="leaderboard">
            <h3>GLOBAL TOP 10 üèÜ</h3>
            <div id="scoreList">Lade Bestenliste...</div>
        </div>

        <div id="gameWrapper">
            <div id="uiPanel">
                <div>‚≠ê <span id="score">0</span></div>
                <div>‚ù§Ô∏è <span id="lives">3</span></div>
                <div>‚è± <span id="time">30</span></div>
            </div>

            <div id="levelIndicator">
                LVL <span id="lvlNum">1</span> | Ziel: <span id="curTarget">0</span>/70%
                <div class="goal-bar-bg"><div id="goalBarFill"></div></div>
            </div>

            <canvas id="game" width="400" height="600"></canvas>

            <div id="controlBar">
                <input type="range" id="slider" min="35" max="365" value="180">
            </div>

            <div class="overlay" id="startScreen">
                <p style="margin-bottom:20px; line-height:1.5; font-size:0.8rem;">
                    Sammle mindestens 70% der Punkte, um das Level zu bestehen!
                </p>
                <input type="text" id="playerName" placeholder="DEIN NAME" maxlength="10">
                <button onclick="startGame()">START</button>
            </div>

            <div class="overlay" id="gameOver" style="display:none;">
                <h2 style="color:var(--retro-red); font-family:'Press Start 2P'; margin-bottom:10px;">GAME OVER</h2>
                <p style="font-size:0.8rem;">DEIN SCORE:</p>
                <p id="finalScore" style="font-size:3rem; margin:10px; color:var(--retro-yellow);"></p>
                <button onclick="restart()">NOCHMAL</button>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const slider = document.getElementById("slider");
    
    let state = "start";
    let score, lives, timeLeft, items, dog, spawnTimer;
    let currentLevel, itemsSpawned, itemsCaught;
    let audioCtx;

    // --- AUDIO SYSTEM ---
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playSound(freq, type, duration, vol) {
        if (!audioCtx) return;
        let o = audioCtx.createOscillator();
        let g = audioCtx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + duration);
    }

    function playLevelUp() {
        playSound(400, "square", 0.1, 0.1);
        setTimeout(() => playSound(600, "square", 0.1, 0.1), 100);
        setTimeout(() => playSound(800, "square", 0.3, 0.1), 200);
    }

    // --- PHP RANGLISTE ---
    async function loadHighscores() {
        try {
            const res = await fetch('save_score.php');
            const data = await res.json();
            document.getElementById("scoreList").innerHTML = data.map((s, i) => 
                `<div class="score-row"><span>${i+1}. ${s.name}</span><span>${s.points}</span></div>`
            ).join("");
        } catch (e) { console.log("Ladefehler"); }
    }

    async function saveScore(name, points) {
        try {
            await fetch('save_score.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name, score: points})
            });
            loadHighscores();
        } catch (e) { console.log("Speicherfehler"); }
    }

    // --- GAME LOGIK ---
    function init(lvl = 1) {
        if(lvl === 1) { score = 0; lives = 3; }
        timeLeft = 30;
        items = [];
        spawnTimer = 0;
        currentLevel = lvl;
        itemsSpawned = 0;
        itemsCaught = 0;
        dog = { x: 180, y: 480 };
        document.getElementById("lvlNum").innerText = currentLevel;
        updateGoalUI();
    }

    slider.addEventListener("input", e => { dog.x = parseInt(e.target.value); });

    function updateGoalUI() {
        const percent = itemsSpawned > 0 ? Math.round((itemsCaught / itemsSpawned) * 100) : 0;
        document.getElementById("curTarget").innerText = percent;
        document.getElementById("goalBarFill").style.width = Math.min(percent/0.7, 100) + "%";
    }

    function spawn() {
        let r = Math.random();
        let item = { x: 40 + Math.random() * 320, y: -40, speed: 3 + (currentLevel * 0.7) };
        if (r < 0.2) { 
            item.type = "üëÆ"; item.danger = true; 
        } else {
            item.type = r < 0.5 ? "üçó" : (r < 0.8 ? "üç™" : "ü¶¥");
            item.val = (item.type === "üçó" ? 10 : (item.type === "üç™" ? 5 : 2));
            itemsSpawned++;
        }
        items.push(item);
    }

    function startGame() {
        if (!document.getElementById("playerName").value.trim()) return alert("Name?");
        initAudio();
        init(1);
        state = "play";
        document.getElementById("startScreen").style.display = "none";
        loop();
        loadHighscores();
    }

    function loop() {
        if (state !== "play") return;
        ctx.clearRect(0,0,400,600);
        
        // Hintergrund Deko
        ctx.fillStyle = "#6cc24a"; ctx.fillRect(0, 540, 400, 60);

        spawnTimer++;
        if (spawnTimer > Math.max(15, 45 - currentLevel * 2)) { spawn(); spawnTimer = 0; }

        for (let i = items.length - 1; i >= 0; i--) {
            let it = items[i];
            it.y += it.speed;
            ctx.font = "35px Arial";
            ctx.fillText(it.type, it.x - 17, it.y);

            // Kollision (Hund sitzt bei y=480)
            if (it.y > 460 && it.y < 510 && it.x > dog.x - 30 && it.x < dog.x + 30) {
                if (it.danger) {
                    lives--;
                    playSound(150, "sawtooth", 0.3, 0.1);
                    if (lives <= 0) return endGame();
                } else {
                    itemsCaught++;
                    score += it.val;
                    playSound(600, "sine", 0.1, 0.05);
                }
                items.splice(i, 1);
                updateGoalUI();
            } else if (it.y > 600) {
                items.splice(i, 1);
                updateGoalUI();
            }
        }

        ctx.font = "50px Arial";
        ctx.fillText("üê∂", dog.x - 25, dog.y + 25);

        timeLeft -= 1/60;
        document.getElementById("score").innerText = score;
        document.getElementById("lives").innerText = lives;
        document.getElementById("time").innerText = Math.max(0, Math.ceil(timeLeft));

        if (timeLeft <= 0) {
            checkLevelProgress();
        } else {
            requestAnimationFrame(loop);
        }
    }

    function checkLevelProgress() {
        const ratio = itemsCaught / itemsSpawned;
        if (ratio >= 0.7) {
            playLevelUp();
            alert("LEVEL " + currentLevel + " BESTANDEN! ü¶¥");
            init(currentLevel + 1);
            requestAnimationFrame(loop);
        } else {
            lives--;
            playSound(100, "sawtooth", 0.5, 0.1);
            if (lives > 0) {
                alert("ZU WENIG PUNKTE! (Ziel: 70%). Ein Herz verloren.");
                init(currentLevel);
                requestAnimationFrame(loop);
            } else {
                endGame();
            }
        }
    }

    function endGame() {
        state = "over";
        const name = document.getElementById("playerName").value;
        saveScore(name, score);
        document.getElementById("finalScore").innerText = score;
        document.getElementById("gameOver").style.display = "flex";
    }

    function restart() {
        document.getElementById("gameOver").style.display = "none";
        document.getElementById("startScreen").style.display = "flex";
        loadHighscores();
    }

    loadHighscores();
</script>

</body>
</html>
