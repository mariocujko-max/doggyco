<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doggyco 14.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(#1b2735, #090a0f);
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            color: white;
            user-select: none;
            touch-action: none;
        }

        #wrap {
            position: relative;
            max-width: 450px;
            height: 100vh;
            margin: auto;
            overflow: hidden;
            border-left: 2px solid #333;
            border-right: 2px solid #333;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 14px;
            z-index: 10;
            text-shadow: 2px 2px 4px #000;
        }

        .big { font-size: 20px; }

        #barWrap {
            position: absolute;
            top: 60px;
            left: 5%;
            width: 90%;
            height: 12px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #444;
        }

        #bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #ff416c, #ff4b2b, #00ff00);
            transition: width 0.1s linear;
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 20;
            text-align: center;
        }

        button {
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(45deg, #00ffcc, #00ccff);
            font-size: 22px;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="wrap">
    <div id="ui">
        <div class="big">‚≠ê <span id="score">0</span></div>
        <div class="big" id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="big">LVL <span id="lvl">1</span></div>
        <div class="big">‚è≥ <span id="timer">30</span></div>
    </div>

    <div id="barWrap"><div id="bar"></div></div>

    <canvas id="game"></canvas>

    <div class="overlay" id="startScreen">
        <h1 style="font-size: 40px; color: #00ffcc;">DOGGYCO</h1>
        <p>Sammle Knochen, weiche der Polizei und den Spinnen aus!</p>
        <button onclick="startGame()">START</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    let W, H, lanes = 5, laneW;
    let dogLane = 2, dogX = 0, targetX = 0;
    let items = [], spiders = [], bubbles = [], clouds = [];
    let score = 0, level = 1, hearts = 3, timeLeft = 30;
    let animationId;
    let dragging = false;

    function resize() {
        const r = canvas.getBoundingClientRect();
        canvas.width = r.width;
        canvas.height = r.height;
        W = canvas.width;
        H = canvas.height;
        laneW = W / lanes;
        dogX = laneW * dogLane + laneW / 2;
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, dur) {
        try {
            let osc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.start();
            osc.stop(audioCtx.currentTime + dur);
        } catch(e) {}
    }

    function startGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        resize();
        initBackground();
        initSpiders();
        document.getElementById("startScreen").style.display = "none";
        loop();
    }

    function initBackground() {
        clouds = [];
        for (let i = 0; i < 4; i++)
            clouds.push({ x: Math.random() * W, y: 50 + Math.random() * 150, s: 0.2 + Math.random() * 0.5 });
    }

    function initSpiders() {
        spiders = [];
        for (let i = 0; i < 2; i++) {
            spiders.push({ x: 50 + Math.random() * (W - 100), t: Math.random() * 5, speed: 0.01 + Math.random() * 0.02 });
        }
    }

    // Input Handling
    const updateDogPos = (clientX) => {
        let rect = canvas.getBoundingClientRect();
        let x = clientX - rect.left;
        let newLane = Math.floor(x / laneW);
        dogLane = Math.max(0, Math.min(lanes - 1, newLane));
    };

    canvas.addEventListener("mousedown", (e) => { dragging = true; updateDogPos(e.clientX); });
    window.addEventListener("mousemove", (e) => { if (dragging) updateDogPos(e.clientX); });
    window.addEventListener("mouseup", () => dragging = false);

    canvas.addEventListener("touchstart", (e) => { dragging = true; updateDogPos(e.touches[0].clientX); }, {passive: false});
    canvas.addEventListener("touchmove", (e) => { if (dragging) updateDogPos(e.touches[0].clientX); }, {passive: false});
    canvas.addEventListener("touchend", () => dragging = false);

    function spawn() {
        if (items.length >= 8) return;
        let lane = Math.floor(Math.random() * lanes);
        if (items.some(it => it.lane === lane && it.y < 100)) return;
        
        let r = Math.random();
        let type, val, bad = false;
        
        if (r < 0.2) { type = "üëÆ"; bad = true; }
        else if (r < 0.4) { type = "üçó"; val = 5; }
        else if (r < 0.7) { type = "üç™"; val = 2; }
        else { type = "ü¶¥"; val = 1; }
        
        items.push({ lane, y: -50, type, val, bad });
    }

    function loop() {
        animationId = requestAnimationFrame(loop);
        ctx.clearRect(0, 0, W, H);

        // Sky
        let grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#1a2a6c");
        grad.addColorStop(1, "#b21f1f");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

        // Clouds
        ctx.fillStyle = "rgba(255,255,255,0.5)";
        clouds.forEach(c => {
            c.x += c.s;
            if (c.x > W + 50) c.x = -50;
            ctx.beginPath();
            ctx.arc(c.x, c.y, 20, 0, Math.PI * 2);
            ctx.arc(c.x + 15, c.y - 10, 20, 0, Math.PI * 2);
            ctx.arc(c.x + 30, c.y, 20, 0, Math.PI * 2);
            ctx.fill();
        });

        // Road
        ctx.fillStyle = "#222";
        ctx.fillRect(0, H - 140, W, 140);
        ctx.strokeStyle = "yellow";
        ctx.setLineDash([20, 20]);
        for(let i=1; i<lanes; i++) {
            ctx.beginPath();
            ctx.moveTo(i * laneW, H - 140);
            ctx.lineTo(i * laneW, H);
            ctx.stroke();
        }
        ctx.setLineDash([]);

        // Timer Logic
        timeLeft -= 1/60;
        if (timeLeft <= 0) {
            level++;
            timeLeft = 30;
            playTone(800, 0.2);
        }
        document.getElementById("timer").innerText = Math.ceil(timeLeft);
        document.getElementById("bar").style.width = (timeLeft / 30 * 100) + "%";

        if (Math.random() < 0.02 + level * 0.005) spawn();

        // Items logic
        for (let i = items.length - 1; i >= 0; i--) {
            let it = items[i];
            it.y += 3 + level * 0.7;
            let x = it.lane * laneW + laneW / 2;
            
            ctx.font = "40px Arial";
            ctx.textAlign = "center";
            ctx.fillText(it.type, x, it.y);

            // Collision Dog
            if (it.y > H - 150 && it.y < H - 80 && it.lane === dogLane) {
                if (it.bad) {
                    hearts--;
                    playTone(150, 0.4);
                    bubbles.push({ x, y: it.y, text: "-üíî", life: 40 });
                } else {
                    score += it.val * level;
                    playTone(600 + it.val * 50, 0.1);
                    bubbles.push({ x, y: it.y, text: "+" + (it.val * level), life: 40 });
                }
                items.splice(i, 1);
            } else if (it.y > H) {
                items.splice(i, 1);
            }
        }

        // Spiders logic
        spiders.forEach(s => {
            s.t += s.speed;
            let sy = (Math.sin(s.t) + 1) / 2 * (H - 250);
            
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(s.x, 0);
            ctx.lineTo(s.x, sy);
            ctx.stroke();
            ctx.font = "30px Arial";
            ctx.fillText("üï∑Ô∏è", s.x, sy + 20);

            // Collision Spider mit Dog
            // Pr√ºft, ob Spider auf H√∂he des Hundes ist UND ob der Hund in derselben Lane ist
            let spiderLane = Math.floor(s.x / laneW);
            if (spiderLane === dogLane && sy > H - 200 && sy < H - 80) {
                timeLeft -= 0.1; // Zieht Zeit ab, solange man drin steht
                ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                ctx.fillRect(0,0,W,H);
            }
        });

        // Dog Movement
        targetX = dogLane * laneW + laneW / 2;
        dogX += (targetX - dogX) * 0.2;
        ctx.font = "60px Arial";
        ctx.fillText("üê∂", dogX, H - 90);

        // Bubbles (Floating Text)
        for (let i = bubbles.length - 1; i >= 0; i--) {
            let b = bubbles[i];
            b.y -= 2;
            b.life--;
            ctx.fillStyle = "yellow";
            ctx.font = "bold 24px Orbitron";
            ctx.fillText(b.text, b.x, b.y);
            if (b.life <= 0) bubbles.splice(i, 1);
        }

        // Update UI
        document.getElementById("score").innerText = score;
        document.getElementById("hearts").innerText = "‚ù§Ô∏è".repeat(hearts);
        document.getElementById("lvl").innerText = level;

        if (hearts <= 0) {
            cancelAnimationFrame(animationId);
            setTimeout(() => {
                alert("GAME OVER! Dein Score: " + score);
                location.reload();
            }, 100);
        }
    }
</script>
</body>
</html>
