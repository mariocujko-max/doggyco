
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let W, H, lanes = 5, laneW;
let dogLane = 2, dogX = 0;
let items = [], spiders = [], clouds = [], birds = [];
let score = 0, level = 1, hearts = 3;
let timeLeft = 30;
let active = false;

let lastTime = 0;
let musicInterval = null;

/* ------------------ AUDIO ------------------ */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playBeep(f, t, d, v=0.1){
    if(audioCtx.state === "suspended") audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = t;
    o.frequency.value = f;
    g.gain.setValueAtTime(v, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + d);
}

function startMusic(){
    if(musicInterval) clearInterval(musicInterval);
    musicInterval = setInterval(()=>{
        if(active) playBeep(90 + level*5, "sine", 0.4, 0.02);
    }, 900);
}

/* ------------------ RESIZE ------------------ */
function resize(){
    W = canvas.width = canvas.parentElement.offsetWidth;
    H = canvas.height = canvas.parentElement.offsetHeight;
    laneW = W / lanes;
    dogX = dogLane * laneW + laneW/2;
}
window.onresize = resize;
resize();

/* ------------------ INPUT ------------------ */
const move = (e)=>{
    if(!active) return;
    const x = (e.touches ? e.touches[0].clientX : e.clientX)
        - canvas.getBoundingClientRect().left;
    dogLane = Math.max(0, Math.min(lanes-1, Math.floor(x/laneW)));
};
canvas.onmousemove = move;
canvas.ontouchmove = e => { e.preventDefault(); move(e); };

/* ------------------ START ------------------ */
function startGame(){
    active = true;
    document.getElementById("startScreen").classList.add("hidden");
    clouds = [];
    for(let i=0;i<4;i++){
        clouds.push({x:Math.random()*W,y:Math.random()*H*0.3,s:0.3+Math.random()*0.4});
    }
    startMusic();
    lastTime = performance.now();
    requestAnimationFrame(loop);
}

/* ------------------ LOOP ------------------ */
function loop(timestamp){
    if(!active) return;

    const delta = (timestamp - lastTime)/1000;
    lastTime = timestamp;

    ctx.clearRect(0,0,W,H);

    /* ----- Background ----- */
    ctx.fillStyle="rgba(255,255,255,0.15)";
    clouds.forEach(c=>{
        c.x += c.s;
        if(c.x>W+20) c.x=-20;
        ctx.beginPath();
        ctx.arc(c.x,c.y,15,0,Math.PI*2);
        ctx.fill();
    });

    /* ----- Birds ----- */
    if(Math.random()<0.002)
        birds.push({x:W+40,y:50+Math.random()*120,s:100+level*20});

    for(let i=birds.length-1;i>=0;i--){
        let b=birds[i];
        b.x -= b.s*delta;
        ctx.font="20px Arial";
        ctx.fillText("üê¶",b.x,b.y);
        if(b.x<-40) birds.splice(i,1);
    }

    /* ----- Timer ----- */
    timeLeft -= delta;
    let progress = (timeLeft/30)*100;
    document.getElementById("lvlBar").style.width =
        Math.max(0,progress)+"%";

    if(timeLeft<=0){
        level++;
        timeLeft=30;
        document.getElementById("lvl").innerText=level;
        playBeep(700,"sine",0.2);
    }

    /* ----- Items ----- */
    if(Math.random()<0.02+level*0.005){
        items.push({
            lane:Math.floor(Math.random()*lanes),
            y:-40,
            type:Math.random()<0.2?"üëÆ":"ü¶¥"
        });
    }

    for(let i=items.length-1;i>=0;i--){
        let it=items[i];
        it.y += (220+level*40)*delta;
        let ix = it.lane*laneW + laneW/2;
        ctx.font="40px Arial";
        ctx.textAlign="center";
        ctx.fillText(it.type,ix,it.y);

        const dogY = H-90;

        if(it.lane===dogLane &&
           it.y>dogY-40 &&
           it.y<dogY+20){

            if(it.type==="üëÆ"){
                loseHeart();
            } else {
                score+=10;
                playBeep(500,"sine",0.1);
            }
            items.splice(i,1);
        }
        else if(it.y>H+40){
            items.splice(i,1);
        }
    }

    /* ----- Spiders (balanced) ----- */
    if(spiders.length<2){
        spiders.push({
            x:Math.random()*W,
            t:Math.random()*6,
            speed:1+Math.random()
        });
    }

    spiders.forEach(s=>{
        s.t += delta*s.speed;
        let sy = (Math.sin(s.t)+1)/2*(H-150);

        ctx.strokeStyle="#444";
        ctx.beginPath();
        ctx.moveTo(s.x,0);
        ctx.lineTo(s.x,sy);
        ctx.stroke();

        ctx.fillText("üï∑Ô∏è",s.x,sy+25);

        if(Math.abs(s.x-dogX)<30 &&
           sy>H-160){
            timeLeft -= 0.5*delta;
        }
    });

    /* ----- Dog Smooth ----- */
    let targetX = dogLane*laneW + laneW/2;
    dogX += (targetX-dogX)*8*delta;

    ctx.font="60px Arial";
    ctx.fillText("üê∂",dogX,H-70);

    document.getElementById("score").innerText=score;

    requestAnimationFrame(loop);
}

/* ------------------ HEART SYSTEM ------------------ */
function loseHeart(){
    hearts--;
    playBeep(120,"sawtooth",0.4);

    const hd=document.getElementById("heartDisplay");
    hd.classList.add("pop");
    setTimeout(()=>hd.classList.remove("pop"),300);

    hd.innerText="‚ù§Ô∏è".repeat(hearts);

    if(hearts<=0){
        active=false;
        clearInterval(musicInterval);
        document.getElementById("gameOverScreen")
            .classList.remove("hidden");
        document.getElementById("finalScore")
            .innerText="Punkte: "+score;
    }
}
</script>
