<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Doggyco: Enchanted Forest V31</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    :root { --forest-light: #7cfc00; --ui-gold: #ffd700; --glass: rgba(255, 255, 255, 0.2); }
    * { margin:0; padding:0; box-sizing:border-box; touch-action:none; }
    body { overflow:hidden; font-family:'Orbitron', sans-serif; background:#2d5a27; color: white; }

    #wrap {
        position:relative; height:100vh; max-width:500px; margin:auto; overflow:hidden;
        background: linear-gradient(to bottom, #87ceeb 0%, #2d5a27 100%);
        border: 4px solid #fff; transition: border-color 0.5s;
    }

    /* HUD */
    #hud {
        position: absolute; top: 15px; width: 100%; display: flex; 
        justify-content: space-around; align-items: center; z-index: 60;
    }
    .hud-box {
        background: var(--glass); border: 2px solid white;
        padding: 5px 12px; border-radius: 12px; backdrop-filter: blur(5px);
        text-align: center; min-width: 90px;
    }
    #hearts-ui { font-size: 20px; color: #ff3131; text-shadow: 0 0 5px white; }
    .label { font-size: 9px; color: white; text-transform: uppercase; font-weight: 900; }
    .val { font-size: 16px; font-weight: 900; color: white; }

    #energy-wrap {
        position: absolute; top: 80px; left: 15%; width: 70%; height: 12px; 
        background: rgba(0,0,0,0.3); border: 2px solid white; border-radius: 20px; overflow: hidden; z-index: 60;
    }
    #energy-bar { height: 100%; width: 100%; background: var(--forest-light); transition: width 0.1s linear; }

    canvas { width: 100%; height: 100%; display: block; }

    .overlay {
        position:absolute; inset:0; background:rgba(45, 90, 39, 0.9); display:flex; flex-direction:column;
        justify-content:center; align-items:center; z-index:100; text-align: center; padding: 25px;
    }

    .btn-action {
        padding: 15px 45px; font-size: 20px; background: white; color: #2d5a27;
        border: none; border-radius: 50px; cursor: pointer; font-family: 'Orbitron';
        font-weight: 900; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .btn-action:hover { transform: scale(1.05); background: var(--ui-gold); }

    .leaderboard { width: 100%; font-size: 13px; margin: 15px 0; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; }
    .lb-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }

    .pulse { animation: borderPulse 1s infinite alternate; }
    @keyframes borderPulse { from { border-color: white; box-shadow: 0 0 10px white; } to { border-color: var(--ui-gold); box-shadow: 0 0 30px var(--ui-gold); } }
</style>
</head>
<body>

<div id="wrap">
    <div id="hud">
        <div class="hud-box" id="hearts-ui">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="hud-box">
            <span class="label">SCORE</span>
            <span class="val" id="score-val">0</span>
        </div>
        <div class="hud-box">
            <span class="label">LVL</span>
            <span class="val" id="lvl-val">1</span>
        </div>
    </div>

    <div id="energy-wrap"><div id="energy-bar"></div></div>

    <canvas id="game"></canvas>

    <div class="overlay" id="start-screen">
        <h1 style="font-size: 36px; margin-bottom: 10px;">DOGGYCO</h1>
        <p style="font-size: 12px; margin-bottom: 20px; letter-spacing: 2px;">ENCHANTED FOREST</p>
        <div class="leaderboard" id="lb-start"></div>
        <button class="btn-action" onclick="initGame()">START ENGINE</button>
    </div>

    <div class="overlay" style="display:none;" id="game-over">
        <h2 style="color:var(--ui-gold); margin-bottom: 10px;">MISSION ENDE</h2>
        <div id="rank-msg" style="font-size: 18px; margin-bottom: 20px;">Berechne Rang...</div>
        <div style="font-size: 50px; margin-bottom: 30px;" id="final-score">0</div>
        <button class="btn-action" onclick="location.reload()">NOCHMAL SPIELEN</button>
    </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let W, H, lanes = 5, laneW;
let dogLane = 2, dogX = 0, targetX = 0;
let items = [], spiders = [], leaves = [], floatingTexts = [];
let score = 0, hearts = 3, energy = 100, level = 1, active = false;
let lastTime = 0, heartSpawnedInLevel = false;

// Audio
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(f, t, d, v=0.05) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    let o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(v, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+d);
}

function startMusic() {
    let notes = [261, 329, 392, 523]; // Fr√∂hliche C-Dur Noten
    let i = 0;
    setInterval(() => {
        if(active) {
            playTone(notes[i%notes.length], 'sine', 1, 0.02);
            i++;
        }
    }, 1000);
}

function resize() {
    W = canvas.width = canvas.parentElement.offsetWidth;
    H = canvas.height = canvas.parentElement.offsetHeight;
    laneW = W / lanes;
}
window.onresize = resize; resize();

// Leaderboard
function loadLB() {
    let s = JSON.parse(localStorage.getItem('doggyV31') || '[]');
    let html = '<b>TOP RANGERS</b><br>';
    s.slice(0, 3).forEach((x, i) => html += `<div class="lb-row"><span>#${i+1} Ranger</span><span>${x}</span></div>`);
    document.getElementById('lb-start').innerHTML = html;
}
loadLB();

function saveScore(s) {
    let scores = JSON.parse(localStorage.getItem('doggyV31') || '[]');
    scores.push(s); scores.sort((a,b) => b-a);
    localStorage.setItem('doggyV31', JSON.stringify(scores.slice(0, 10)));
    return scores.indexOf(s) + 1;
}

const handleInput = (e) => {
    if(!active) return;
    let rect = canvas.getBoundingClientRect();
    let x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    dogLane = Math.floor(x / laneW);
    dogLane = Math.max(0, Math.min(lanes-1, dogLane));
}
canvas.onmousemove = handleInput;
canvas.ontouchmove = (e) => { e.preventDefault(); handleInput(e); };

function initGame() {
    document.getElementById("start-screen").style.display = "none";
    active = true;
    lastTime = performance.now();
    for(let i=0; i<10; i++) leaves.push({x: Math.random()*W, y: Math.random()*H, s: 0.5+Math.random(), r: Math.random()*Math.PI});
    startMusic();
    requestAnimationFrame(loop);
}

function loop(t) {
    if(!active) return;
    let delta = (t - lastTime) / 1000;
    lastTime = t;
    ctx.clearRect(0,0,W,H);

    // Deko: Fallende Bl√§tter
    ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
    leaves.forEach(l => {
        l.y += l.s; l.x += Math.sin(l.y/50);
        if(l.y > H) l.y = -10;
        ctx.beginPath(); ctx.arc(l.x, l.y, 3, 0, Math.PI*2); ctx.fill();
    });

    // Energie-Logik (Sanfterer Abzug)
    energy -= (1.2 + level*0.4) * delta;
    document.getElementById("energy-bar").style.width = energy + "%";
    if(energy < 20) { hearts--; energy = 70; playTone(150, 'sawtooth', 0.5); }

    // Spawn Items (Angenehmer Rhythmus)
    if(Math.random() < 0.01 + level*0.005){
        let type = "ü¶¥";
        let r = Math.random();
        if(r < 0.05) type = "üëÆ";
        else if(r < 0.12) type = "üçñ";
        else if(r < 0.15 && !heartSpawnedInLevel) { type = "‚ù§Ô∏è"; heartSpawnedInLevel = true; }
        items.push({lane: Math.floor(Math.random()*lanes), y: -60, type});
    }

    // Items Bewegung & Kollision
    for(let i=items.length-1; i>=0; i--){
        let it = items[i];
        it.y += (150 + level*50) * delta;
        let ix = it.lane*laneW + laneW/2;
        ctx.font="40px Arial"; ctx.textAlign="center";
        ctx.fillText(it.type, ix, it.y);

        if(it.lane===dogLane && it.y > H-150 && it.y < H-80){
            if(it.type === "üëÆ") { hearts--; playTone(100, 'sawtooth', 0.4); }
            else if(it.type === "‚ù§Ô∏è") { if(hearts<3) hearts++; score+=50; playTone(800, 'sine', 0.3); }
            else {
                let p = it.type === "üçñ" ? 30 : 10;
                score += p; energy = Math.min(100, energy + 15);
                playTone(400+p*5, 'sine', 0.1);
                floatingTexts.push({x:ix, y:it.y, v:"+"+p, l:1});
            }
            items.splice(i,1);
        } else if(it.y > H) items.splice(i,1);
    }

    // Spinnen (Langsamer & Pr√§ziser H√∂hen-Check)
    if(spiders.length < 2) spiders.push({x: Math.random()*W, t: 0, s: 0.012});
    spiders.forEach(s => {
        s.t += s.s; let sy = (Math.sin(s.t)+1)/2 * (H-120);
        ctx.strokeStyle = "rgba(255,255,255,0.4)";
        ctx.beginPath(); ctx.moveTo(s.x,0); ctx.lineTo(s.x,sy); ctx.stroke();
        ctx.fillText("üï∑Ô∏è", s.x, sy+25);
        
        // Kollision nur wenn Spinne auf Hunde-H√∂he ist
        let dx = Math.abs(s.x - dogX);
        let dy = Math.abs(sy - (H-100)); 
        if(dx < 35 && dy < 40) {
            energy -= 0.5; // Zieht Energie ab statt Leben
            ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(0,0,W,H);
        }
    });

    // Dog
    targetX = dogLane*laneW+laneW/2;
    dogX += (targetX - dogX) * 0.2;
    ctx.font="60px Arial"; ctx.fillText("üê∂", dogX, H-80);

    // UI & Level-Up
    document.getElementById("score-val").innerText = score;
    document.getElementById("hearts-ui").innerText = "‚ù§Ô∏è".repeat(Math.max(0, hearts));
    document.getElementById("lvl-val").innerText = level;

    if(score > level * 250) { level++; heartSpawnedInLevel = false; playTone(900, 'square', 0.2); }

    if(hearts <= 0) { 
        active = false; 
        let rank = saveScore(score);
        document.getElementById("wrap").classList.add("pulse");
        document.getElementById("game-over").style.display = "flex";
        document.getElementById("final-score").innerText = score;
        document.getElementById("rank-msg").innerText = "DU BIST RANG #" + rank + "!";
    } else {
        requestAnimationFrame(loop);
    }
}
</script>
</body>
</html>

